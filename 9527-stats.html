<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‰“å¡ç»Ÿè®¡ - ç®¡ç†åå°</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useEffect } = React;

// JSONBin.io é…ç½® - ä¸ä¸»é¡µé¢ä¿æŒä¸€è‡´
const JSONBIN_CONFIG = {
  MASTER_KEY: '$2a$10$qRrYfYJdq8z7r0HSTaR7zewZOvUGxBLe3Khsp9swhKMAaCPJf9XZe',
  BIN_ID: '693f3f3743b1c97be9ee63d6'
};

function StatsApp() {
  const [participants, setParticipants] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [binId, setBinId] = useState('');

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    setLoading(true);
    setError(null);
    setBinId(JSONBIN_CONFIG.BIN_ID);
    
    try {
      const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_CONFIG.BIN_ID}/latest`, {
        headers: { 'X-Master-Key': JSONBIN_CONFIG.MASTER_KEY }
      });
      
      if (res.ok) {
        const data = await res.json();
        setParticipants(data.record.participants || []);
      } else {
        setError('è·å–æ•°æ®å¤±è´¥');
      }
    } catch (e) {
      setError('ç½‘ç»œé”™è¯¯ï¼š' + e.message);
    }
    
    setLoading(false);
  };

  const exportCSV = () => {
    const headers = ['å§“å', 'åˆ†æ•°', 'æ€»é¢˜æ•°', 'ç§°å·', 'å®Œæˆæ—¶é—´'];
    const rows = participants.map(p => [p.name, p.score, p.total, p.title, p.time]);
    const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
    
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `æ‰“å¡ç»Ÿè®¡_${new Date().toLocaleDateString('zh-CN')}.csv`;
    link.click();
  };

  const getStats = () => {
    if (participants.length === 0) return null;
    const avgScore = (participants.reduce((sum, p) => sum + p.score, 0) / participants.length).toFixed(1);
    const perfectCount = participants.filter(p => p.score === p.total).length;
    const titleCounts = {};
    participants.forEach(p => {
      titleCounts[p.title] = (titleCounts[p.title] || 0) + 1;
    });
    return { avgScore, perfectCount, titleCounts };
  };

  const stats = getStats();

  return (
    <div className="min-h-screen bg-slate-900 text-white p-6">
      <div className="max-w-4xl mx-auto">
        <div className="flex items-center justify-between mb-8">
          <div>
            <h1 className="text-2xl font-bold bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">
              æ‰“å¡ç»Ÿè®¡åå°
            </h1>
            <p className="text-slate-400 text-sm mt-1">æ–‡èƒœå†›AIç¼–ç¨‹è®­ç»ƒè¥ï¼ˆç¬¬ä¸€è¯¾ï¼‰</p>
          </div>
          <div className="flex gap-3">
            <button 
              onClick={loadData}
              className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-colors"
            >
              ğŸ”„ åˆ·æ–°
            </button>
            <button 
              onClick={exportCSV}
              disabled={participants.length === 0}
              className="px-4 py-2 bg-green-600 hover:bg-green-500 disabled:bg-slate-700 disabled:text-slate-500 rounded-lg text-sm transition-colors"
            >
              ğŸ“¥ å¯¼å‡º CSV
            </button>
          </div>
        </div>

        {loading && (
          <div className="text-center py-20 text-slate-400">
            <div className="animate-spin text-4xl mb-4">â³</div>
            åŠ è½½ä¸­...
          </div>
        )}

        {error && (
          <div className="bg-red-500/20 border border-red-500 rounded-xl p-6 text-center">
            <p className="text-red-300">{error}</p>
            <button 
              onClick={loadData}
              className="mt-4 px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-sm"
            >
              é‡è¯•
            </button>
          </div>
        )}

        {!loading && !error && (
          <>
            {/* ç»Ÿè®¡å¡ç‰‡ */}
            {stats && (
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                  <div className="text-3xl font-bold text-purple-400">{participants.length}</div>
                  <div className="text-slate-400 text-sm">æ€»å‚ä¸äººæ•°</div>
                </div>
                <div className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                  <div className="text-3xl font-bold text-blue-400">{stats.avgScore}</div>
                  <div className="text-slate-400 text-sm">å¹³å‡åˆ†æ•°</div>
                </div>
                <div className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                  <div className="text-3xl font-bold text-yellow-400">{stats.perfectCount}</div>
                  <div className="text-slate-400 text-sm">æ»¡åˆ†äººæ•°</div>
                </div>
                <div className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                  <div className="text-3xl font-bold text-green-400">
                    {participants.length > 0 ? ((stats.perfectCount / participants.length) * 100).toFixed(0) : 0}%
                  </div>
                  <div className="text-slate-400 text-sm">æ»¡åˆ†ç‡</div>
                </div>
              </div>
            )}

            {/* ç§°å·åˆ†å¸ƒ */}
            {stats && (
              <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 mb-8">
                <h2 className="text-lg font-bold mb-4">ç§°å·åˆ†å¸ƒ</h2>
                <div className="flex flex-wrap gap-3">
                  {Object.entries(stats.titleCounts).map(([title, count]) => (
                    <div key={title} className="bg-slate-700 px-4 py-2 rounded-full text-sm">
                      <span className="text-purple-300">{title}</span>
                      <span className="text-white ml-2 font-bold">{count}äºº</span>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* å‚ä¸è€…åˆ—è¡¨ */}
            <div className="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
              <div className="p-4 border-b border-slate-700">
                <h2 className="text-lg font-bold">å‚ä¸è€…åå• ({participants.length}äºº)</h2>
              </div>
              
              {participants.length === 0 ? (
                <div className="p-8 text-center text-slate-400">
                  æš‚æ— æ•°æ®ï¼Œç­‰å¾…ç”¨æˆ·å®ŒæˆæŒ‘æˆ˜...
                </div>
              ) : (
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-slate-700/50">
                      <tr>
                        <th className="text-left px-4 py-3 text-sm text-slate-300">#</th>
                        <th className="text-left px-4 py-3 text-sm text-slate-300">å§“å</th>
                        <th className="text-left px-4 py-3 text-sm text-slate-300">åˆ†æ•°</th>
                        <th className="text-left px-4 py-3 text-sm text-slate-300">ç§°å·</th>
                        <th className="text-left px-4 py-3 text-sm text-slate-300">å®Œæˆæ—¶é—´</th>
                      </tr>
                    </thead>
                    <tbody>
                      {participants.map((p, i) => (
                        <tr key={i} className="border-t border-slate-700 hover:bg-slate-700/30">
                          <td className="px-4 py-3 text-slate-400">{i + 1}</td>
                          <td className="px-4 py-3 font-medium">{p.name}</td>
                          <td className="px-4 py-3">
                            <span className={p.score === p.total ? 'text-yellow-400 font-bold' : ''}>
                              {p.score}/{p.total}
                            </span>
                          </td>
                          <td className="px-4 py-3 text-purple-300">{p.title}</td>
                          <td className="px-4 py-3 text-slate-400 text-sm">{p.time}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>

            {binId && (
              <div className="mt-4 text-center text-slate-500 text-xs">
                Bin ID: {binId}
              </div>
            )}
          </>
        )}
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<StatsApp />);
  </script>
</body>
</html>
